import wixWindow from 'wix-window';
import wixData from 'wix-data';
import {session} from 'wix-storage';

let thisUser
let ratings = null;
let average = null;
let allRatings = null;
allRatings = [];
ratings = [];
average = [];
let agentAverage
let ratingsApproved;
let showReviewsCount = 0;
let count = 0
let allApproved = 0;

$w.onReady(function () {

    // Get the user's selected template from the dataset
    $w('#agentsDataset').onReady(() => {
        const userTemplate = $w('#agentsDataset').getCurrentItem().template;
        var itemData = $w('#agentsDataset').getCurrentItem()

        let status = "Approved";
        let agentEmail = itemData.email
        session.setItem("agentEmail", agentEmail)
        getReviews(agentEmail, status)

        console.log(agentEmail);

        // Set the state of the multistate box based on the user's template
        let stateName;
        switch (userTemplate) {
        case 'Template1':
            stateName = 'Template1';
            break;
        case 'Template2':
            stateName = 'Template2';
            break;
        case 'Template3':
            stateName = 'Template3';
            break;
        default:
            stateName = 'Template1'; // default state
        }
        $w('#templateMultistateBox').changeState(stateName); // Change the state name as needed

        if (itemData.achievements === undefined || itemData.achievements === "") {
            $w('#t3achievements').hide()
            $w('#t2achievements').hide()
            $w('#t1achievements').hide()
        }
        if (itemData.facebookUrl === undefined || itemData.facebookUrl === "") {
            $w('#t1facebook').collapse()
            $w('#t2facebook').collapse()
            $w('#t3facebook').collapse()
        }
        if (itemData.linkedinUrl === undefined || itemData.linkedinUrl === "") {
            $w('#t1linkedin').collapse()
            $w('#t2linkedin').collapse()
            $w('#t3linkedin').collapse()
        }
        if (itemData.instagramUrl === undefined || itemData.instagramUrl === "") {
            $w('#t1instagram').collapse()
            $w('#t2instagram').collapse()
            $w('#t3instagram').collapse()
        }
        if (itemData.xurl === undefined || itemData.xurl === "") {
            $w('#t1x').collapse()
            $w('#t2x').collapse()
            $w('#t3x').collapse()
        }
    });
});

$w.onReady(function () {

    /*
    $w("#leaveReview1").onClick(async (event) => {
        const user = await $w("#agentsDataset").getCurrentItem();
        const dataForLightbox = {
            userId: user._id
        };
        let result = await wixWindow.openLightbox('Write A Review', dataForLightbox);
    });
    */

});

export function leaveReview3_click(event) {

	let userData = $w("#agentsDataset").getCurrentItem();

    wixWindow.openLightbox('Write A Review', userData)
		.then( (data) => {

			let receivedData = data;

			if (receivedData === "Reviewed"){

            $w("#leaveReview3").label = "Review Received"

			}
		} );
}


export function getReviews(email, status){
ratingsApproved = null;
ratingsApproved = [];
let thisTotal = 3
let newItems = null;
newItems = [];
let countedTotal = 0



    console.log("Get Ratings:")

    wixData.query("Team")
                    .eq("email", email)         
                    .find() 
                    .then((results) => { 
						console.log("Found user", results)

						let userRatings = results.items[0].ratings; 
                        let totalRatingsCount = results.items[0].ratings.length;
						let userId = results.items[0]._id; 
						session.setItem("thisUser", userId)
                        console.log("Ratings:", userRatings)
						console.log("userId:", userId)
                        let firstLoadCount = 0;
                        

                        if(userRatings !== undefined && userRatings.length > 0){
                           

                            let totalCount = userRatings.length;

                            userRatings.forEach(function(rating) {
                                countedTotal++
                                console.log("Totals: ", countedTotal, allApproved)

                                let approvedCount = 0;

								if(rating.status == "Approved"){
                                    approvedCount++

                                    ratingsApproved.push(rating); //Remove for final push
                                    console.log("Approved", ratingsApproved) //Remove for final push


                                        let allApprovedRatings = ratingsApproved.length;

                                         console.log("Totals: ", countedTotal, allApprovedRatings, totalRatingsCount)


                                        if(totalRatingsCount == countedTotal){
                                             console.log("New Items: ",  newItems)

                                              console.log("This Person: ", ratingsApproved[count])
                                                if(ratingsApproved[count] !== undefined && count <= thisTotal){
                                                newItems.push(ratingsApproved[count])
                                                count++
                                                }

                                                if(ratingsApproved[count] !== undefined && count <= thisTotal){
                                                newItems.push(ratingsApproved[count])
                                                count++
                                                }

                                                if(ratingsApproved[count] !== undefined && count <= thisTotal){
                                                newItems.push(ratingsApproved[count])
                                                count++
                                                }
                                             

                                                if(count == 3 || count == allApprovedRatings){
                                                
                                                let reviewsRepeater = $w('#reviewsList')

                                                reviewsRepeater.data = newItems;

                                            console.log("Features Data: ", reviewsRepeater.data)


                                            reviewsRepeater.onItemReady(($item, itemData) => {
                                                console.log(itemData.item)
                                              
                                          
                                                reviewsRepeater.forEachItem( ($item, itemData, index) => {

                                                        let rated = itemData.rating

                                                    $item('#reviewerName').text = itemData.name;
                                                    $item('#reviewerText').text = itemData.comment;
                                                    $w("#reviewsList").expand();

                                                        if(Number(rated) == 1){
                                                            $item("#s1b").show();
                                                            $item("#s2b").hide();
                                                            $item("#s3b").hide();
                                                            $item("#s4b").hide();
                                                            $item("#s5b").hide();

                                                            //$item("#b1b").hide();
                                                            //$item("#b2b").show();
                                                            //$item("#b3b").show();
                                                            //$item("#b4b").show();
                                                            //$item("#b5b").show();

                                                        }


                                                        if(Number(rated) == 2){
                                                            $item("#s1b").show();
                                                            $item("#s2b").show();
                                                            $item("#s3b").hide();
                                                            $item("#s4b").hide();
                                                            $item("#s5b").hide();

                                                            //$item("#b1b").hide();
                                                            //$item("#b2b").hide();
                                                            //$item("#b3b").show();
                                                            //$item("#b4b").show();
                                                            //$item("#b5b").show();

                                                        }


                                                        if(Number(rated) == 3){
                                                            $item("#s1b").show();
                                                            $item("#s2b").show();
                                                            $item("#s3b").show();
                                                            $item("#s4b").hide();
                                                            $item("#s5b").hide();

                                                            //$item("#b1b").hide();
                                                            //$item("#b2b").hide();
                                                            //$item("#b3b").hide();
                                                            //$item("#b4b").show();
                                                            //$item("#b5b").show();

                                                        }


                                                        if(Number(rated) == 4){

                                                                $item("#s1b").show();
                                                                $item("#s2b").show();
                                                                $item("#s3b").show();
                                                                $item("#s4b").show();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").hide();
                                                                //$item("#b3b").hide();
                                                                //$item("#b4b").hide();
                                                                //$item("#b5b").show();

                                                        }


                                                        if(Number(rated) == 5){
                                                                $item("#s1b").show();
                                                                $item("#s2b").show();
                                                                $item("#s3b").show();
                                                                $item("#s4b").show();
                                                                $item("#s5b").show();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").hide();
                                                                //$item("#b3b").hide();
                                                                //$item("#b4b").hide();
                                                                //$item("#b5b").hide();

                                                        }

                                                        } );

                                                        

                                                })
                                                console.log("Show Button: ", count, allApprovedRatings);

                                                 if ( allApprovedRatings > 3 ){
                                                    $w('#loadMore').show();
                                                }

                                            }
                                        }
                                        

								}

                                /*
                                if(count == totalCount){

                                    loadRepeaterData(ratingsApproved)

                                

                                }
                                */

                                




							})
                        }

                    })

}

export function loadRepeaterData(repeaterData){
  

						let reviewsRepeater = $w('#reviewsList')
															
								reviewsRepeater.data = [];

                                

								reviewsRepeater.data = repeaterData
								console.log("Repeater Data: ", reviewsRepeater.data)
                                
								reviewsRepeater.onItemReady(($item, itemData) => {

                                    let rated = itemData.rating

										$item('#reviewerName').text = itemData.name;
                                        $item('#reviewerText').text = itemData.comment;
                                        $w("#reviewsList").expand();

                                if(Number(rated) == 1){
                                    $item("#s1b").show();
                                    $item("#s2b").hide();
                                    $item("#s3b").hide();
                                    $item("#s4b").hide();
                                    $item("#s5b").hide();

                                    //$item("#b1b").hide();
                                    //$item("#b2b").show();
                                    //$item("#b3b").show();
                                    //$item("#b4b").show();
                                    //$item("#b5b").show();

                                }


                                if(Number(rated) == 2){
                                    $item("#s1b").show();
                                    $item("#s2b").show();
                                    $item("#s3b").hide();
                                    $item("#s4b").hide();
                                    $item("#s5b").hide();

                                    //$item("#b1b").hide();
                                    //$item("#b2b").hide();
                                    //$item("#b3b").show();
                                    //$item("#b4b").show();
                                    //$item("#b5b").show();

                                }


                                 if(Number(rated) == 3){
                                    $item("#s1b").show();
                                    $item("#s2b").show();
                                    $item("#s3b").show();
                                    $item("#s4b").hide();
                                    $item("#s5b").hide();

                                    //$item("#b1b").hide();
                                    //$item("#b2b").hide();
                                    //$item("#b3b").hide();
                                    //$item("#b4b").show();
                                    //$item("#b5b").show();

                                }


                                if(Number(rated) == 4){

                                    	$item("#s1b").show();
                                        $item("#s2b").show();
                                        $item("#s3b").show();
                                        $item("#s4b").show();
                                        $item("#s5b").hide();

                                        //$item("#b1b").hide();
                                        //$item("#b2b").hide();
                                        //$item("#b3b").hide();
                                        //$item("#b4b").hide();
                                        //$item("#b5b").show();

                                }


                                if(Number(rated) == 5){
                                    	$item("#s1b").show();
                                        $item("#s2b").show();
                                        $item("#s3b").show();
                                        $item("#s4b").show();
                                        $item("#s5b").show();

                                        //$item("#b1b").hide();
                                        //$item("#b2b").hide();
                                        //$item("#b3b").hide();
                                        //$item("#b4b").hide();
                                        //$item("#b5b").hide();

                                }

                                $item("#reviewsList").expand();
                                 $item("#line18").expand();
									
								})


}

export function loadMore_click(event) {
	loadMoreFunction()
}

export function loadMoreFunction(){
    console.log("loadMore")
	session.setItem("Clicked","Start")


								let allItems = ratingsApproved.length
								let total = ratingsApproved.length
                                console.log("All Items: ", allItems, total)
                                console.log(ratingsApproved[0])

                                
                                
								
								if(ratingsApproved !== undefined && ratingsApproved !== ""){
									
									console.log("Data: ", ratingsApproved, count)
									let newItems = [];


											if(ratingsApproved[count] !== undefined && count < allItems){
												console.log("Added: ", ratingsApproved[count])
												newItems.push(ratingsApproved[count])
												count++
												console.log("Count", allItems, total)
												session.setItem("Clicked","Pending")
											}

											if(ratingsApproved[count] !== undefined && count < allItems){
												console.log("Added: ", ratingsApproved[count])
												newItems.push(ratingsApproved[count])
												count++
												console.log("Count", allItems, total)
												session.setItem("Clicked","Pending")
											}

											if(ratingsApproved[count] !== undefined && count < allItems){
												console.log("Added: ", ratingsApproved[count])
												newItems.push(ratingsApproved[count])
												count++
												console.log("Count", allItems, total)
												session.setItem("Clicked","Pending")
											}

                                            if($w('#reviewsList').data.length < 3){

                                    
										console.log("RESTART")

										count = 0
										//count ++
										let thisTotal = 3

                                        console.log("This Person: ", ratingsApproved[count])
										if(ratingsApproved[count] !== undefined && count <= thisTotal){
										console.log("Added Restart: ", ratingsApproved[count])
										newItems.push(ratingsApproved[count])
										count++
                                        }

                                        if(ratingsApproved[count] !== undefined && count <= thisTotal){
										console.log("Added Restart 2: ", ratingsApproved[count])
										newItems.push(ratingsApproved[count])
										count++
                                        }

                                        if(ratingsApproved[count] !== undefined && count <= thisTotal){
										console.log("Added Restart 3: ", ratingsApproved[count])
										newItems.push(ratingsApproved[count])
										count++
                                        }

                                        if(count == 3){

                                            let reviewsList = $w('#reviewsList')
										
													reviewsList.data = newItems;

													console.log("Reviews Data: ", reviewsList.data)

													reviewsList.onItemReady(($item, itemData) => {


														 let rated = itemData.rating

                                                        $item('#reviewerName').text = itemData.name;
                                                        $item('#reviewerText').text = itemData.comment;
                                                        $w("#reviewsList").expand();

                                                            if(Number(rated) == 1){
                                                                $item("#s1b").show();
                                                                $item("#s2b").hide();
                                                                $item("#s3b").hide();
                                                                $item("#s4b").hide();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").show();
                                                                //$item("#b3b").show();
                                                                //$item("#b4b").show();
                                                                //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 2){
                                                                $item("#s1b").show();
                                                                $item("#s2b").show();
                                                                $item("#s3b").hide();
                                                                $item("#s4b").hide();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").hide();
                                                                //$item("#b3b").show();
                                                                //$item("#b4b").show();
                                                                //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 3){
                                                                $item("#s1b").show();
                                                                $item("#s2b").show();
                                                                $item("#s3b").show();
                                                                $item("#s4b").hide();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").hide();
                                                                //$item("#b3b").hide();
                                                                //$item("#b4b").show();
                                                                //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 4){

                                                                    $item("#s1b").show();
                                                                    $item("#s2b").show();
                                                                    $item("#s3b").show();
                                                                    $item("#s4b").show();
                                                                    $item("#s5b").hide();

                                                                    //$item("#b1b").hide();
                                                                    //$item("#b2b").hide();
                                                                    //$item("#b3b").hide();
                                                                    //$item("#b4b").hide();
                                                                    //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 5){
                                                                    $item("#s1b").show();
                                                                    $item("#s2b").show();
                                                                    $item("#s3b").show();
                                                                    $item("#s4b").show();
                                                                    $item("#s5b").show();

                                                                    //$item("#b1b").hide();
                                                                    //$item("#b2b").hide();
                                                                    //$item("#b3b").hide();
                                                                    //$item("#b4b").hide();
                                                                    //$item("#b5b").hide();

                                                            }

                                                    })

                                        }





                                    }

													let reviewsList = $w('#reviewsList')
										
													reviewsList.data = newItems;
													console.log("Reviews Data: ", reviewsList.data)

													reviewsList.onItemReady(($item, itemData) => {


														 let rated = itemData.rating

                                                        $item('#reviewerName').text = itemData.name;
                                                        $item('#reviewerText').text = itemData.comment;
                                                        $w("#reviewsList").expand();

                                                            if(Number(rated) == 1){
                                                                $item("#s1b").show();
                                                                $item("#s2b").hide();
                                                                $item("#s3b").hide();
                                                                $item("#s4b").hide();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").show();
                                                                //$item("#b3b").show();
                                                                //$item("#b4b").show();
                                                                //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 2){
                                                                $item("#s1b").show();
                                                                $item("#s2b").show();
                                                                $item("#s3b").hide();
                                                                $item("#s4b").hide();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").hide();
                                                                //$item("#b3b").show();
                                                                //$item("#b4b").show();
                                                                //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 3){
                                                                $item("#s1b").show();
                                                                $item("#s2b").show();
                                                                $item("#s3b").show();
                                                                $item("#s4b").hide();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").hide();
                                                                //$item("#b3b").hide();
                                                                //$item("#b4b").show();
                                                                //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 4){

                                                                    $item("#s1b").show();
                                                                    $item("#s2b").show();
                                                                    $item("#s3b").show();
                                                                    $item("#s4b").show();
                                                                    $item("#s5b").hide();

                                                                    //$item("#b1b").hide();
                                                                    //$item("#b2b").hide();
                                                                    //$item("#b3b").hide();
                                                                    //$item("#b4b").hide();
                                                                    //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 5){
                                                                    $item("#s1b").show();
                                                                    $item("#s2b").show();
                                                                    $item("#s3b").show();
                                                                    $item("#s4b").show();
                                                                    $item("#s5b").show();

                                                                    //$item("#b1b").hide();
                                                                    //$item("#b2b").hide();
                                                                    //$item("#b3b").hide();
                                                                    //$item("#b4b").hide();
                                                                    //$item("#b5b").hide();

                                                            }
														
						
													})
													session.setItem("Clicked","End")

													

										


									let getStatus = session.getItem("Clicked")

                                    

									if(count == total && getStatus =="Start"){
										console.log("Finished", ratingsApproved)

										count = 0
										
										let thisTotal = 3
										console.log("Counts", count, thisTotal)


										if(ratingsApproved[count] !== undefined && count <= thisTotal){
										console.log("Added: ", ratingsApproved[count])
										newItems.push(ratingsApproved[count])
										count++
									}

									if(ratingsApproved[count] !== undefined && count <= thisTotal){
										console.log("Added: ", ratingsApproved[count])
										newItems.push(ratingsApproved[count])
										count++
									}

									if(ratingsApproved[count] !== undefined && count <= thisTotal){
										console.log("Added: ", ratingsApproved[count])
										newItems.push(ratingsApproved[count])
										count++
									}

									if(ratingsApproved[count] !== undefined && count <= thisTotal){
										console.log("Added: ", ratingsApproved[count])
										newItems.push(ratingsApproved[count])
										count++
										console.log(count)
									}

										if(count == 3){
										

											let reviewsList = $w('#reviewsList')
										
										reviewsList.data = newItems;
										console.log("Reviews Data Refreshed: ", reviewsList.data)

										reviewsList.onItemReady(($item, itemData) => {


											reviewsList.forEachItem( ($item, itemData, index) => {

                                                 let rated = itemData.rating

                                                        $item('#reviewerName').text = itemData.name;
                                                        $item('#reviewerText').text = itemData.comment;
                                                        $w("#reviewsList").expand();

                                                            if(Number(rated) == 1){
                                                                $item("#s1b").show();
                                                                $item("#s2b").hide();
                                                                $item("#s3b").hide();
                                                                $item("#s4b").hide();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").show();
                                                                //$item("#b3b").show();
                                                                //$item("#b4b").show();
                                                                //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 2){
                                                                $item("#s1b").show();
                                                                $item("#s2b").show();
                                                                $item("#s3b").hide();
                                                                $item("#s4b").hide();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").hide();
                                                                //$item("#b3b").show();
                                                                //$item("#b4b").show();
                                                                //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 3){
                                                                $item("#s1b").show();
                                                                $item("#s2b").show();
                                                                $item("#s3b").show();
                                                                $item("#s4b").hide();
                                                                $item("#s5b").hide();

                                                                //$item("#b1b").hide();
                                                                //$item("#b2b").hide();
                                                                //$item("#b3b").hide();
                                                                //$item("#b4b").show();
                                                                //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 4){

                                                                    $item("#s1b").show();
                                                                    $item("#s2b").show();
                                                                    $item("#s3b").show();
                                                                    $item("#s4b").show();
                                                                    $item("#s5b").hide();

                                                                    //$item("#b1b").hide();
                                                                    //$item("#b2b").hide();
                                                                    //$item("#b3b").hide();
                                                                    //$item("#b4b").hide();
                                                                    //$item("#b5b").show();

                                                            }


                                                            if(Number(rated) == 5){
                                                                    $item("#s1b").show();
                                                                    $item("#s2b").show();
                                                                    $item("#s3b").show();
                                                                    $item("#s4b").show();
                                                                    $item("#s5b").show();

                                                                    //$item("#b1b").hide();
                                                                    //$item("#b2b").hide();
                                                                    //$item("#b3b").hide();
                                                                    //$item("#b4b").hide();
                                                                    //$item("#b5b").hide();

                                                            }

													
													} );

													

											})

										}


                                        if(reviewsList.data.length < 3){

                                            $w('#loadMore').hide();

                                        } else {

                                            $w('#loadMore').show();
                                        }






									}


								}
								

							

}
